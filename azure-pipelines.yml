pool: 
  vmImage: 'windows-2019'

pr: none

variables:
  - group: vmusers
  - name: 'major'
    value: '1'
  - name: 'minor'
    value: '2'
  - name: 'requiredModules'
    value: 'GuestConfiguration' 
  - name: 'linuxConfigName'
    value: 'firewalldenabled'
  - name: 'windowsConfigName'
    value: 'windowsfirewallenabled'
  - name: 'resourcegroup'
    value: 'contosodev-rfc_customguestconfig'

trigger:
  branches:
    include:
    - master
    - dev
  paths:
    exclude:
    - README.md
    - LICENSE
    - .gitignore
    - .github/*

steps:
- task: PowerShell@2
  inputs:
    targetType: inline
    pwsh: 'false'
    script: |
      
      # Install required modules from PowerShell Gallery
      Install-Module -Name $(requiredModules),PSScriptAnalyzer -Repository 'PSGallery' -Scope 'CurrentUser' -Verbose -Force
      
  displayName: 'Setup/validate Windows PowerShell environment'

- task: PowerShell@2
  inputs:
    targetType: inline
    pwsh: 'false'
    script: |
      
      # Lint PowerShell scripts
      Invoke-ScriptAnalyzer -Path '$(System.DefaultWorkingDirectory)\guestConfiguration\' -IncludeDefaultRules -Recurse -Severity Error -ReportSummary -EnableExit

  displayName: 'Lint PowerShell scripts in Guest Configuration content'

- task: PowerShell@2
  inputs:
    targetType: inline
    pwsh: 'false'
    script: |

      # Compile DSC MOF files
      
        # Linux configuration
        . $(System.DefaultWorkingDirectory)\guestConfiguration\Linux\$(linuxConfigName).ps1
        $(linuxConfigName) -out '$(System.DefaultWorkingDirectory)\guestConfiguration\Linux'

        # Windows configuration
        . $(System.DefaultWorkingDirectory)\guestConfiguration\Windows\$(windowsConfigName).ps1
        $(windowsConfigName) -out '$(System.DefaultWorkingDirectory)\guestConfiguration\Windows'
      
  displayName: 'Compile DSC MOF files'

- task: PowerShell@2
  inputs:
    targetType: inline
    pwsh: 'false'
    script: |

      # Create artifacts folder
      New-Item -Path '$(System.DefaultWorkingDirectory)\artifacts\' -Type Directory
      
      # Create artifacts
      
        # New guest configuration package for Linux
        New-GuestConfigurationPackage -Name '$(linuxConfigName)' `
        -Configuration '$(System.DefaultWorkingDirectory)\guestConfiguration\Linux\$(linuxConfigName).mof' `
        -FilesToInclude '$(System.DefaultWorkingDirectory)\guestConfiguration\Linux\InSpecProfiles' `
        -DestinationPath '$(System.DefaultWorkingDirectory)\artifacts\' `
        -Verbose

        # New guest configuration package for Windows
        New-GuestConfigurationPackage -Name '$(windowsConfigName)' `
        -Configuration '$(System.DefaultWorkingDirectory)\guestConfiguration\Windows\$(windowsConfigName).mof' `
        -DestinationPath '$(System.DefaultWorkingDirectory)\artifacts\' `
        -Verbose

      # Confirm output
      Write-Verbose 'Validate artifacts folder:'
      Test-Path -Path '$(System.DefaultWorkingDirectory)\artifacts\' -Verbose
      Write-Verbose 'Validate Linux artifact'
      Test-Path -Path '$(System.DefaultWorkingDirectory)\artifacts\$(linuxConfigName)\$(linuxConfigName).zip' -Verbose
      Write-Verbose 'Validate Windows artifact'
      Test-Path -Path '$(System.DefaultWorkingDirectory)\artifacts\$(windowsConfigName)\$(windowsConfigName).zip' -Verbose
  
  continueOnError: 'true'
  displayName: 'Create content artifacts'

- task: AzurePowerShell@4
  inputs:
    azureSubscription: 'ARM'
    azurePowerShellVersion: 'latestVersion'
    scriptType: 'inlineScript'
    inline: |
      
      # Verify resource group exists
      $ResourceGroup = Get-AzResourceGroup -Name $(resourcegroup) -ErrorAction SilentlyContinue
      if ($null -eq $ResourceGroup) {$ResourceGroup = New-AzResourceGroup -Name $(resourcegroup) -Location 'eastus2' -Verbose}

      # Verify storage account exists
      $StorageAccount = Get-AzStorageAccount -ResourceGroupName $(resourcegroup) -AccountName 'guestconfiguration' -ErrorAction SilentlyContinue
      if ($null -eq $StorageAccount) {$StorageAccount = New-AzStorageAccount -ResourceGroupName $(resourcegroup) -AccountName 'guestconfiguration' -Location eastus -SkuName Standard_GRS -Verbose}
      $Context = $StorageAccount.Context

      # Verify storage container exists
      $Container = $StorageAccount | Get-AzStorageContainer -Name 'artifacts' -ErrorAction SilentlyContinue
      if ($null -eq $Container) {$Container = New-AzStorageContainer -Name 'artifacts' -Context $Context -Permission Off -Verbose}

      # Upload files
      Set-AzStorageBlobContent -Context $Context -Container $Container.Name -File '$(System.DefaultWorkingDirectory)\artifacts\$(linuxConfigName)\$(linuxConfigName).zip' -Blob '$(linuxConfigName).zip' -Force -Verbose
      Set-AzStorageBlobContent -Context $Context -Container $Container.Name -File '$(System.DefaultWorkingDirectory)\artifacts\$(windowsConfigName)\$(windowsConfigName).zip' -Blob '$(windowsConfigName).zip' -Force -Verbose

      # Get url with SAS token
      $StartTime = (Get-Date)
      $ExpiryTime = $StartTime.AddYears('3')
      $linuxArtifactSAS = New-AzStorageBlobSASToken -Context $Context -Container $Container.Name -Blob 'firewalldenabled.zip' -StartTime $StartTime -ExpiryTime $ExpiryTime -Permission rl -FullUri -Verbose
      $windowsArtifactSAS = New-AzStorageBlobSASToken -Context $Context -Container $Container.Name -Blob 'windowsfirewallenabled.zip' -StartTime $StartTime -ExpiryTime $ExpiryTime -Permission rl -FullUri -Verbose

      # Overwrite definition/initiative files
      New-GuestConfigurationPolicy -ContentUri $linuxArtifactSAS -DisplayName 'Firewalld is Enabled' -Description 'Validates that the Firewalld package is installed, running, and that the default zone is public' -Version 1.0.0.0 -DestinationPath '$(System.DefaultWorkingDirectory)\policyFiles\Linux' -Platform Linux -Verbose
      New-GuestConfigurationPolicy -ContentUri $windowsArtifactSAS -DisplayName 'Windows Firewall is Enabled' -Description 'Validates that the Windows host firewall package is enabled and that the default zone is public' -Version 1.0.0.0 -DestinationPath '$(System.DefaultWorkingDirectory)\policyFiles\Windows' -Platform Windows -Verbose

      # Publish definitions/initiatives
      $publishedLinuxPolicies = Publish-GuestConfigurationPolicy -Path '$(System.DefaultWorkingDirectory)\policyFiles\Linux\' -Verbose
      $publishedWindowsPolicies = Publish-GuestConfigurationPolicy -Path '$(System.DefaultWorkingDirectory)\policyFiles\Windows\' -Verbose

      # Assign Linux policy
      $linuxInitiative = Get-AzPolicySetDefinition -Name $publishedLinuxPolicies.Name
      $ResourceGroup = Get-AzResourceGroup -Name $(resourcegroup)

      $linuxAssignment = @{
        Name = '725e67e5-c735-4b97-aa65-7d805f8a169c'
        DisplayName = 'Audit when Firewalld is not enabled'
        Description = 'Validates that the Firewalld package is installed, running, and that the default zone is public'
        PolicySetDefinition = $linuxInitiative
        Scope = $ResourceGroup.ResourceId
        Location = 'eastus2'
        AssignIdentity = $true
      }
      $linuxAssignment = New-AzPolicyAssignment @linuxAssignment

        # Hold for directory replication and then create role assignment for Linux policy assignment
        Start-sleep 60
        $deployDef = Get-AzPolicyDefinition -Name '163804a7-0bb0-4c98-a888-e6393dc92389'
        $roleDefinitionIds = $deployDef.Properties.policyRule.then.details.roleDefinitionIds
        if ($roleDefinitionIds.Count -gt 0)
        {
            $roleDefinitionIds | ForEach-Object {
                $roleDefId = $_.Split("/") | Select-Object -Last 1
                $roleAssignment = Get-AzRoleAssignment -Scope $ResourceGroup.ResourceId -ObjectId $linuxAssignment.Identity.PrincipalId -RoleDefinitionId $roleDefId -ErrorAction SilentlyContinue
                If ($null -eq $roleAssignment) {
                  New-AzRoleAssignment -Scope $ResourceGroup.ResourceId -ObjectId $linuxAssignment.Identity.PrincipalId -RoleDefinitionId $roleDefId -ErrorAction SilentlyContinue
                }
            }
        }

      # Assign Windows policy
      $windowsInitiative = Get-AzPolicySetDefinition -Name $publishedWindowsPolicies.Name
      $ResourceGroup = Get-AzResourceGroup -Name $(resourcegroup)

      $windowsAssignment = @{
        Name = 'f93be1ec-e122-4a0e-9876-fef6487b9848'
        DisplayName = 'Audit when Windows Firewall is not Enabled'
        Description = 'Validates that the Windows host firewall package is enabled and that the default zone is public'
        PolicySetDefinition = $windowsInitiative
        Scope = $ResourceGroup.ResourceId
        Location = 'eastus2'
        AssignIdentity = $true
      }
      $windowsAssignment = New-AzPolicyAssignment @windowsAssignment

        # Hold for directory replication and then create role assignment for Windows policy assignment
        Start-sleep 60
        $deployDef = Get-AzPolicyDefinition -Name '163804a7-0bb0-4c98-a888-e6393dc92389'
        $roleDefinitionIds = $deployDef.Properties.policyRule.then.details.roleDefinitionIds
        if ($roleDefinitionIds.Count -gt 0)
        {
            $roleDefinitionIds | ForEach-Object {
                $roleDefId = $_.Split("/") | Select-Object -Last 1
                $roleAssignment = Get-AzRoleAssignment -Scope $ResourceGroup.ResourceId -ObjectId $windowsAssignment.Identity.PrincipalId -RoleDefinitionId $roleDefId -ErrorAction SilentlyContinue
                If ($null -eq $roleAssignment) {
                  New-AzRoleAssignment -Scope $ResourceGroup.ResourceId -ObjectId $windowsAssignment.Identity.PrincipalId -RoleDefinitionId $roleDefId -ErrorAction SilentlyContinue
                }
            }
        }

  displayName: 'Publish content to Azure'  
